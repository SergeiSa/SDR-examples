close all; clear classes; clc;

tol = 10^(-5);

% [0, 0, phi_1, phi_2]
q = [0; 0; 0; 0];
v = zeros(size(q));
x = [q; v];
u = 0;

Handler_dynamics_generalized_coordinates_model = SRD_get('Handler_dynamics_generalized_coordinates_model');
Handler_dynamics_Linearized_Model              = SRD_get('Handler_dynamics_Linearized_Model');
Handler_Constraints_Model                      = SRD_get('Handler_Constraints_Model');


k = Handler_Constraints_Model.dof_Constraint;
n = Handler_dynamics_generalized_coordinates_model.dof_configuration_space_robot;
m = Handler_dynamics_generalized_coordinates_model.dof_control;

H = Handler_dynamics_generalized_coordinates_model.get_joint_space_inertia_matrix(q);
c = Handler_dynamics_generalized_coordinates_model.get_bias_vector(q, v);
T = [0;0;0;1];
iH = pinv(H);
f0 = [v; iH*(T*u - c)];

A = Handler_dynamics_Linearized_Model.get_A(q, v, u, iH);
B = Handler_dynamics_Linearized_Model.get_B(q, v,    iH);
g = f0 - A * x - B * u;


C_case0 = [...
    % 1 0 0 0 0 0 0 0;
    % 0 1 0 0 0 0 0 0;
    % 0 0 1 0 0 0 0 0;
     0 0 0 1 0 0 0 0;
    % 0 0 0 0 1 0 0 0;
    % 0 0 0 0 0 1 0 0;
    % 0 0 0 0 0 0 1 0;
    % 0 0 0 0 0 0 0 1...
    ]; 
 
C_case1 = [...
     %1 0 0 0 0 0 0 0;
     %0 1 0 0 0 0 0 0;
     0 0 1 0 0 0 0 0;
     0 0 0 1 0 0 0 0;
    % 0 0 0 0 1 0 0 0;
    % 0 0 0 0 0 1 0 0;
     0 0 0 0 0 0 1 0;
     0 0 0 0 0 0 0 1]; 
 
C_case2 = [...
     1 0 0 0 0 0 0 0;
     0 1 0 0 0 0 0 0;
     0 0 1 0 0 0 0 0;
     0 0 0 1 0 0 0 0;
    % 0 0 0 0 1 0 0 0;
    % 0 0 0 0 0 1 0 0;
     0 0 0 0 0 0 1 0;
     0 0 0 0 0 0 0 1];
 
C_case3 = [...
     1 0 0 0 0 0 0 0;
     0 1 0 0 0 0 0 0;
     0 0 1 0 0 0 0 0;
     0 0 0 1 0 0 0 0;
    % 0 0 0 0 1 0 0 0;
     0 0 0 0 0 1 0 0;
    % 0 0 0 0 0 0 1 0;
     0 0 0 0 0 0 0 1]; 

C_case4 = eye(2*n); 
 

F  = Handler_Constraints_Model.get_Jacobian(q);
dF = Handler_Constraints_Model.get_Jacobian_derivative(q);
G = [zeros(k, n), F; F, dF];
N = null(G); R = orth(G'); %E = [N, R];


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%D1*dx/dt + D2*x = 0
D1 = [eye(n), zeros(n)];
D2 = [zeros(n), eye(n)];

GG = [G, zeros(2*k, 2*n); D1, D2];
GG = svd_suit(GG, tol);

V = GG.null; V = V((2*n+1):end, :);

Ra = orth(V*pinv(V)*R);
%Rn = orth((eye(2*n) - V*pinv(V))*R);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

NA = svd_suit(N'*A);
Re = NA.row_space;

temp = svd_suit( (Re*Re' * V*pinv(V) * R), tol);
Rae = temp.orth;

temp2 = svd_suit( ( pinv(N'*A)*(N'*A) * V*pinv(V) * R), tol);
Rae2 = temp2.orth;


% our_R = Rae2; C = C_case0; %works
% our_R = Rae2; C = C_case1; %works
% our_R = Rae2; C = C_case2; %works
our_R = Rae2; C = C_case3; %works
% our_R = Rae2; C = C_case4; %works

% our_R = Ra; C = C_case0; % doesn't work - observer is not stabilizable
% our_R = Ra; C = C_case1; % doesn't work - observer is not stabilizable
% our_R = Ra; C = C_case2; % works
% our_R = Ra; C = C_case3; % works
% our_R = Ra; C = C_case4; % works

% our_R = R; C = C_case0; % doesn't work - observer is not stabilizable
% our_R = R; C = C_case1; % doesn't work - observer is not stabilizable
% our_R = R; C = C_case2; % doesn't work - observer is not stabilizable
% our_R = R; C = C_case3; % works
% our_R = R; C = C_case4; % works


E = [N, our_R];

nn_1 = size(N,  2);
nn_2 = size(our_R, 2);
nn = nn_1+nn_2;
mm = size(C, 1);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% IC
radius = 0.01;
x = radius*[0;0;randn;randn; 0;0;0;0]; 
z    = N'*x; 
zeta = our_R'*x; 
xi_est = radius*randn(nn, 1); 
Y0   = [z; xi_est]; 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% desired

desired.x_desired_0    = N*randn(nn_1, 1)*10*radius + our_R*zeta;
desired.z_desired_0    = N'*desired.x_desired_0;
desired.zeta_desired   = zeta; 

desired.M = [N'*A*N, N'*B];
desired.M = svd_suit(desired.M);
desired.N = desired.M.null;
desired.zu_particular = desired.M.pinv * N'*g;
desired.zu_null = desired.N*randn(size(desired.N, 2), 1)* 10*radius;
%desired.zu = desired.zu_particular + desired.zu_null;

desired.map.z = [eye(nn_1),   zeros(nn_1, m)];
desired.map.u = [zeros(m, nn_1), eye(m)];
desired.Projector = (desired.map.z*desired.N) * pinv(desired.map.z*desired.N);
desired

z_des      = desired.zu(1:nn_1);
u_des_calc = desired.zu((1+nn_1):end);
x_des = N*z_des + our_R*zeta;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% u_des and affine term

if norm( (eye(nn_1) - (N'*B)*pinv(N'*B)) *(N'*A*N*z_des + N'*g) ) < tol
    u_des = -pinv(N'*B) *(N'*A*N*z_des + N'*g);
else
    warning('cannot create a node');
end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Kz    = lqr(N'*A*N, N'*B, 100*eye(nn_1), 1*eye(m));
Kzeta = pinv(N'*B) * N'*A*our_R;
K = [Kz, Kzeta];

N1 = [N, zeros(2*n, nn_2)];

A1 = N1'*A*E;
B1 = N1'*B;

% A1 = [N'*A*N,            N'*A*our_R; 
%       zeros(nn_2, nn_1), zeros(nn_2, nn_2)];
% B1 = [N'*B; 
%       zeros(nn_2, m)];

L = lqr(A1', E'*C', 100*eye(nn), eye(mm));
L = L';


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% PLTI in z-xi coordinates

CL_PLTI = [N'*A*N,   -N'*B*K;
           L*C*N,     (A1 - B1*K - L*C*E)];
      
CL_PLTI_g = [N'*A*our_R*zeta + N' *B*Kz*z_des + N' *B*u_des + N' *g;
             L*C*our_R*zeta  + N1'*B*Kz*z_des + N1'*B*u_des + N1'*g];
                 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% LTI in x-xi coordinates
FF = R;
M = [eye(2*n),       zeros(2*n, nn),   -FF;
     zeros(nn, 2*n), eye(nn, nn),       zeros(nn, 2*k);
     G,              zeros(2*k, nn),    zeros(2*k, 2*k)];
iM = pinv(M);
iM11 = iM(1:(2*n+nn), 1:(2*n+nn));

CL_LTI_0 = [A,   -B*K;
            L*C, (A1 - B1*K - L*C*E)];
      
CL_LTI = iM11*CL_LTI_0; 
% [sort(real(eig(CL_LTI_v1)), 'descend'), sort(real(eig(CL_LTI_v2)), 'descend')]

CL_LTI_g0 = [    B*Kz*z_des +     B*u_des +     g;
             N1'*B*Kz*z_des + N1'*B*u_des + N1'*g];
CL_LTI_g = iM11*CL_LTI_g0; 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Time = 12;


g = [N'*A*our_R; L*C*our_R] * zeta;
ODEFUN = get_fnc(CL_PLTI, CL_PLTI_g);

[TOUT,YOUT] = ode45(ODEFUN,[0 Time], Y0);

z        = YOUT(:, 1:nn_1);
z_est    = YOUT(:, (1+nn_1):(2*nn_1));
zeta_est = YOUT(:, (1+2*nn_1):(2*nn_1+nn_2) );
x_est = (N*z_est' + our_R*zeta_est')';

figure('Color', 'w')
subplot(2, 2, 1)
plot(TOUT, z, 'LineWidth', 1.5); hold on; title('z');
plot([TOUT(1); TOUT(end)], [z_des'; z_des'], '--', 'LineWidth', 0.8);

subplot(2, 2, 2)
plot(TOUT, z_est); title('z est')
subplot(2, 2, 3)
if ~isempty(zeta_est)
    plot(TOUT,zeta_est); title('zeta est')
end

subplot(2, 2, 4)

plot(TOUT, x_est, 'LineWidth', 1.5); hold on; title('x est');
plot([TOUT(1); TOUT(end)], [x_des'; x_des'], '--', 'LineWidth', 0.8);


drawnow;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

ODEFUN_CLTI = get_fnc_dynamics(CL_LTI, CL_LTI_g);
Y0 = [x; xi_est]; 

[TOUT, YOUT] = ode45(ODEFUN_CLTI,[0 Time], Y0);

x        = YOUT(:, 1:(2*n));
z_est    = YOUT(:, (1+2*n):(2*n+nn_1));
zeta_est = YOUT(:, (1+2*n+nn_1):(2*n+nn_1+nn_2) );
z_calc = (N'*x')';

figure('Color', 'w')
subplot(3, 2, 1)
plot(TOUT, x, 'LineWidth', 1.5); hold on; title('x');
plot([TOUT(1); TOUT(end)], [x_des'; x_des'], '--', 'LineWidth', 0.8);

subplot(3, 2, 2)
plot(TOUT, z_est); title('z est')
subplot(3, 2, 3)

if ~isempty(zeta_est)
    plot(TOUT, zeta_est); title('zeta est')
end

subplot(3, 2, 4)
plot(TOUT, z_calc); hold on; title('z calc')
plot([TOUT(1); TOUT(end)], [z_des'; z_des'], '--', 'LineWidth', 0.8);
subplot(3, 2, 5)
plot(TOUT, z-z_calc); title('z-z calc')

drawnow;


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


function fnc = get_fnc(CL_PLTI, CL_PLTI_g)

    fnc = @my_fnc;
    function dy = my_fnc(~, y)
        dy = CL_PLTI * y + CL_PLTI_g;
    end

end

function fnc = get_fnc_dynamics(CL_LTI, CL_LTI_g)

    fnc = @my_fnc;
    function dy = my_fnc(~, y)
        dy = CL_LTI * y + CL_LTI_g;
    end

end

